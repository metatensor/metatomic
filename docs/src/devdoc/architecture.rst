.. _devdoc-architecture:

Code organization
=================

The code is organized in three main modules, each in a separate directory:

- ``equistore-core/`` contains the core library, implemented in Rust and exposed
  to the outside world through a C API. This is also where the C++ API lives,
  implemented as a header-only library in ``equistore.hpp``.
- ``equistore/`` contains the Rust interface to equistore, using the C API
  defined in ``equistore-core``, as well as the corresponding tests and examples
- ``python/`` contains the Python interface to equistore, and the corresponding
  tests and examples

Finally, ``docs/`` contains the documentation for everything related to
equistore.

------------------------

.. figure:: ../../static/images/API-organization.*
    :width: 600px
    :align: center

    Logical organization of the modules in the equistore repository. Blue boxes
    are packages that users should interact with, and purple boxes are artifacts
    used by the different languages. Arrows indicate dependencies and data flow
    from one module to another.


``equistore-core``
^^^^^^^^^^^^^^^^^^

This sub-project is supposed to be built by `cmake`_. When building it,
``libequistore.so`` (``libequistore.dylib`` on macOS/``equistore.dll`` on
Windows) and ``equistore.h`` will be produced for consumption by other
modules/the end users.

``equistore.h`` is automatically generated by `cbindgen`_ when building the
code. All functions marked ``#[no_mangle] pub extern fn`` will automatically be
translated to the corresponding C function declaration.

The C++ API in ``equistore.hpp`` is manually written as a header-only library,
exposing the functions from ``equistore.h`` with a cleaner C++11 interface.

``equistore`` rust crate
^^^^^^^^^^^^^^^^^^^^^^^^

This is built by cargo, like a normal Rust project, and re-export a native Rust
interface built on top of the C API. This is a separate module from
``equistore-core`` so that in complex projects with multiple users of equistore,
there can be a single authoritative version of the equistore C API.

When publishing to `crates.io`_, equistore-core is included as a tarball of the
``equistore-core/`` folder (using the ``.crate`` file created by cargo package).
This file should be generated before publishing using
``./equistore/scripts/update-core.sh``. This script also update the Rust
declarations corresponding to the C API (``./equistore/src/c_api.rs``) using
`bindgen`_.

``equistore`` Python package
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

This is built by setuptools/pip, like a normal Python project, and re-export a
native Python interface built on top of the C API. The C API is accessed using
the standard Python `ctypes`_ module. The functions declaration live in
``python/src/equistore/_c_api.py``, and are generated from the functions in
``equistore.h`` by the script ``./python/scripts/generate-declarations.py``.

In addition to the core types of equistore, the Python package also contains a
set of :ref:`operations <python-api-operations>` acting on
:py:class:`equistore.TensorMap` and providing building blocks for machine
learning models on top of the core equistore data structures.


.. _cmake: https://cmake.org/
.. _cbindgen: https://github.com/eqrion/cbindgen/blob/master/docs.md
.. _crates.io: https://crates.io/
.. _bindgen: https://rust-lang.github.io/rust-bindgen/
.. _ctypes: https://docs.python.org/3/library/ctypes.html
